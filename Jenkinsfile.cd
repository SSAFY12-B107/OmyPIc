def sshCommand(command) {
    withCredentials([sshUserPrivateKey(credentialsId: 'ec2-ssh-key', keyFileVariable: 'SSH_KEY')]) {
        return sh(
            script: "ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} '${command}'",
            returnStdout: true
        ).trim()
    }
}

pipeline {
    agent any
    
    environment {
        EC2_HOST = credentials('EC2_SERVER_IP')
        EC2_USER = 'ubuntu'
        DEPLOY_DIR = '/home/ubuntu/OmyPIC'
        DOCKER_REGISTRY = "kst1040"
        BACKEND_IMAGE = "${DOCKER_REGISTRY}/omypic-backend"
        FRONTEND_IMAGE = "${DOCKER_REGISTRY}/omypic-frontend"
        TARGET_ENV = ''
        CURRENT_ENV = ''
        DEPLOYMENT_SUCCESS = false
    }
    
    stages {
        stage('Check MR Target') {
            steps {
                script {
                    if(env.gitlabTargetBranch != 'master') {
                        error("This pipeline only runs for MRs targeting the master branch")
                    }
                }
            }
        }
        
        stage('Determine Target Environment') {
            steps {
                script {
                    // ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
                    sshCommand("cd ${DEPLOY_DIR} && chmod +x health-check.sh switch-script.sh")
                    
                    // í˜„ì¬ í™˜ê²½ í™•ì¸
                    def checkCmd = "cd ${DEPLOY_DIR}/nginx/conf.d && cat upstream.conf | grep -q 'blue' && echo 'blue' || echo 'green'"
                    CURRENT_ENV = sshCommand(checkCmd)
                    TARGET_ENV = CURRENT_ENV == "blue" ? "green" : "blue"
                    
                    echo "í˜„ì¬ í™œì„± í™˜ê²½: ${CURRENT_ENV}, ë°°í¬ íƒ€ê²Ÿ í™˜ê²½: ${TARGET_ENV}"
                }
            }
        }
        
        stage('Deploy to Target') {
            steps {
                script {
                    sshCommand("""
                        cd ${DEPLOY_DIR}
                        docker image pull ${BACKEND_IMAGE}:latest
                        docker image pull ${FRONTEND_IMAGE}:latest
                        docker compose -f docker-compose-${TARGET_ENV}.yml down
                        docker compose -p omypic -f docker-compose-${TARGET_ENV}.yml up -d
                    """)
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    // ë°°í¬ í™˜ê²½ ì•ˆì •í™”ë¥¼ ìœ„í•œ ëŒ€ê¸°
                    echo "ë°°í¬ í™˜ê²½ì´ ì•ˆì •í™”ë  ë•Œê¹Œì§€ 30ì´ˆ ëŒ€ê¸° ì¤‘..."
                    sleep(time: 30, unit: 'SECONDS')
                    
                    // ê¸°ì¡´ health-check.sh ìŠ¤í¬ë¦½íŠ¸ í™œìš©
                    def healthCheckStatus = sshCommand("cd ${DEPLOY_DIR} && ./health-check.sh ${TARGET_ENV}; echo \$?")
                    
                    // ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ ì½”ë“œ í™•ì¸
                    if (healthCheckStatus.trim() != "0") {
                        error "ëŒ€ìƒ í™˜ê²½(${TARGET_ENV})ì˜ í—¬ìŠ¤ ì²´í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŠ¸ë˜í”½ ì „í™˜ì„ ì·¨ì†Œí•©ë‹ˆë‹¤."
                    }
                    
                    echo "í—¬ìŠ¤ ì²´í¬ ì„±ê³µ: ëŒ€ìƒ í™˜ê²½(${TARGET_ENV})ì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤."
                }
            }
        }
        
        stage('Switch Traffic') {
            steps {
                script {
                    // ê¸°ì¡´ switch-script.sh ìŠ¤í¬ë¦½íŠ¸ í™œìš©
                    def switchStatus = sshCommand("cd ${DEPLOY_DIR} && ./switch-script.sh; echo \$?")
                    
                    // ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ ì½”ë“œ í™•ì¸
                    if (switchStatus.trim() != "0") {
                        error "íŠ¸ë˜í”½ ì „í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. switch-script.shì—ì„œ ìë™ ë¡¤ë°±ì´ ìˆ˜í–‰ë˜ì—ˆìŠµë‹ˆë‹¤."
                    }
                    
                    echo "íŠ¸ë˜í”½ ì „í™˜ ì„±ê³µ: ${TARGET_ENV} í™˜ê²½ìœ¼ë¡œ ì „í™˜ ì™„ë£Œ"
                    DEPLOYMENT_SUCCESS = true
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                sshCommand("docker image prune -f")
            }
        }
        
        stage('Update MR Status') {
            steps {
                updateGitlabCommitStatus name: 'build', state: 'success'
                addGitLabMRComment comment: "ğŸ“¦ ë°°í¬ ì™„ë£Œ: ${env.BUILD_URL}\n- í™˜ê²½: ${TARGET_ENV}"
            }
        }
    }
    
    post {
        success {
            echo "ë°°í¬ ì„±ê³µ: ${TARGET_ENV} í™˜ê²½ìœ¼ë¡œ ì „í™˜ ì™„ë£Œ"
            updateGitlabCommitStatus name: 'build', state: 'success'
        }
        
        failure {
            echo "ë°°í¬ ì‹¤íŒ¨: ë¬¸ì œ ë°œìƒ"
            updateGitlabCommitStatus name: 'build', state: 'failed'
            
            script {
                if (TARGET_ENV && !DEPLOYMENT_SUCCESS) {
                    echo "ìƒˆë¡œ ë°°í¬ëœ ${TARGET_ENV} í™˜ê²½ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
                    
                    // íŠ¸ë˜í”½ ì „í™˜ ì „ì— ì‹¤íŒ¨í•œ ê²½ìš°ë§Œ ëŒ€ìƒ í™˜ê²½ ì»¨í…Œì´ë„ˆ ì •ë¦¬
                    // ì „í™˜ í›„ ì‹¤íŒ¨ëŠ” switch-script.shì—ì„œ ì²˜ë¦¬
                    sshCommand("cd ${DEPLOY_DIR} && docker compose -f docker-compose-${TARGET_ENV}.yml down")
                    echo "${TARGET_ENV} í™˜ê²½ì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤."
                }
                
                addGitLabMRComment comment: "âŒ ë°°í¬ ì‹¤íŒ¨: ${env.BUILD_URL}\nì›ì¸ì„ í™•ì¸í•˜ì„¸ìš”."
            }
        }
        
        always {
            cleanWs()
        }
    }
}