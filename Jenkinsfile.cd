def sshCommand(command) {
    withCredentials([sshUserPrivateKey(credentialsId: 'ec2-ssh-key', keyFileVariable: 'SSH_KEY')]) {
        return sh(
            script: "ssh -i \$SSH_KEY -o StrictHostKeyChecking=no \$EC2_USER@\$EC2_HOST '${command}'",
            returnStdout: true
        ).trim()
    }
}

pipeline {
    agent any
    environment {
        EC2_HOST = credentials('EC2_SERVER_IP')
        EC2_USER = 'ubuntu'
        DEPLOY_DIR = '/home/ubuntu/OmyPIC'
        DOCKER_REGISTRY = "kst1040"
        BACKEND_IMAGE = "${DOCKER_REGISTRY}/omypic-backend"
        FRONTEND_IMAGE = "${DOCKER_REGISTRY}/omypic-frontend"
        DEPLOYMENT_SUCCESS = 'false'
    }
    
    stages {
        stage('Check MR Target') {
            steps {
                script {
                    if(env.gitlabTargetBranch != 'master') {
                        error("This pipeline only runs for MRs targeting the master branch")
                    }
                }
            }
        }
        
        stage('Determine Target Environment') {
            steps {
                script {
                    // ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
                    sshCommand("cd ${DEPLOY_DIR} && chmod +x health-check.sh switch-script.sh")
                    
                    // í˜„ì¬ í™˜ê²½ í™•ì¸
                    def checkCmd = "cd ${DEPLOY_DIR}/nginx/conf.d && cat upstream.conf | grep -q 'blue' && echo 'blue' || echo 'green'"
                    def currentEnv = sshCommand(checkCmd)
                    def targetEnv = (currentEnv == "blue") ? "green" : "blue"
                    
                    // í™˜ê²½ ë³€ìˆ˜ì— ê°’ ì„¤ì •
                    env.CURRENT_ENV = currentEnv
                    env.TARGET_ENV = targetEnv
                    
                    echo "í˜„ì¬ í™œì„± í™˜ê²½: ${env.CURRENT_ENV}, ë°°í¬ íƒ€ê²Ÿ í™˜ê²½: ${env.TARGET_ENV}"
                }
            }
        }
        
        stage('Deploy to Target') {
            steps {
                script {
                    sshCommand("""
                        cd ${DEPLOY_DIR}
                        docker image pull ${BACKEND_IMAGE}:latest
                        docker image pull ${FRONTEND_IMAGE}:latest
                        docker compose -p omypic-${env.TARGET_ENV} -f docker-compose-${env.TARGET_ENV}.yml up -d
                    """)
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    echo "ë°°í¬ í™˜ê²½ì´ ì•ˆì •í™”ë  ë•Œê¹Œì§€ 30ì´ˆ ëŒ€ê¸° ì¤‘..."
                    sleep(time: 30, unit: 'SECONDS')
            
                    // ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
                    def containerStatus = sshCommand("cd ${DEPLOY_DIR} && docker ps | grep omypic-${env.TARGET_ENV}")
                    echo "ì»¨í…Œì´ë„ˆ ìƒíƒœ: ${containerStatus}"
            
                    // health-check.sh ì¶œë ¥ ë‚´ìš© í™•ì¸
                    def healthOutput = sshCommand("cd ${DEPLOY_DIR} && ./health-check.sh ${env.TARGET_ENV}")
                    echo "í—¬ìŠ¤ ì²´í¬ ì¶œë ¥: ${healthOutput}"
            
                    // ì¢…ë£Œ ì½”ë“œ í™•ì¸
                    def healthStatus = sshCommand("cd ${DEPLOY_DIR} && ./health-check.sh ${env.TARGET_ENV} >/dev/null 2>&1; echo \$?")
                    echo "í—¬ìŠ¤ ì²´í¬ ìƒíƒœ ì½”ë“œ: ${healthStatus}"
            
                    if (healthStatus.trim() == "0") {
                        echo "í—¬ìŠ¤ ì²´í¬ ì„±ê³µ: ëŒ€ìƒ í™˜ê²½(${env.TARGET_ENV})ì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤."  
                    } else {
                        error "ëŒ€ìƒ í™˜ê²½(${env.TARGET_ENV})ì˜ í—¬ìŠ¤ ì²´í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŠ¸ë˜í”½ ì „í™˜ì„ ì·¨ì†Œí•©ë‹ˆë‹¤."
                    }
                }
            }
        }
        
        stage('Switch Traffic') {
            steps {
                script {
                    // sshCommand í—¬í¼ ëŒ€ì‹  í‘œì¤€ sh ë‹¨ê³„ ì‚¬ìš©
                    withCredentials([sshUserPrivateKey(credentialsId: 'ec2-ssh-key', keyFileVariable: 'SSH_KEY')]) {
                        // ìŠ¤í¬ë¦½íŠ¸ ë§ˆì§€ë§‰ì˜ '; echo $?' ì œê±°
                        // sh ë‹¨ê³„ê°€ ssh ëª…ë ¹ì–´ì˜ ì¢…ë£Œ ì½”ë“œë¥¼ ì§ì ‘ í™•ì¸í•˜ì—¬ ì‹¤íŒ¨ ì²˜ë¦¬í•¨
                        sh "ssh -i \$SSH_KEY -o StrictHostKeyChecking=no \$EC2_USER@\$EC2_HOST 'cd ${DEPLOY_DIR} && CURRENT_ENV=${env.CURRENT_ENV} TARGET_ENV=${env.TARGET_ENV} ./switch-script.sh'"
                    }
                    // ìœ„ sh ë‹¨ê³„ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ë©´ (ìŠ¤í¬ë¦½íŠ¸ê°€ exit 0ìœ¼ë¡œ ì¢…ë£Œë˜ë©´) ì•„ë˜ ë¼ì¸ ì‹¤í–‰
                    echo "íŠ¸ë˜í”½ ì „í™˜ ì„±ê³µ: ${env.TARGET_ENV} í™˜ê²½ìœ¼ë¡œ ì „í™˜ ì™„ë£Œ"
                    env.DEPLOYMENT_SUCCESS = 'true'
                    // sh ë‹¨ê³„ ì‹¤íŒ¨ ì‹œ ìë™ìœ¼ë¡œ ì—ëŸ¬ê°€ ë°œìƒí•˜ê³  post { failure } ë¸”ë¡ìœ¼ë¡œ ë„˜ì–´ê°
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                sshCommand("docker image prune -f")
            }
        }
        
        stage('Update MR Status') {
            steps {
                updateGitlabCommitStatus name: 'build', state: 'success'
                addGitLabMRComment comment: "ğŸ“¦ ë°°í¬ ì™„ë£Œ: ${env.BUILD_URL}\n- í™˜ê²½: ${env.TARGET_ENV}"
            }
        }
    }
    
    post {
        success {
            echo "ë°°í¬ ì„±ê³µ: ${env.TARGET_ENV} í™˜ê²½ìœ¼ë¡œ ì „í™˜ ì™„ë£Œ"
            updateGitlabCommitStatus name: 'build', state: 'success'
        }
        
        failure {
            echo "ë°°í¬ ì‹¤íŒ¨: ë¬¸ì œ ë°œìƒ"
            updateGitlabCommitStatus name: 'build', state: 'failed'
            
            script {
                // ì•ˆì „í•˜ê²Œ ë³€ìˆ˜ í™•ì¸
                if (env.TARGET_ENV && env.DEPLOYMENT_SUCCESS != 'true') {
                    echo "ìƒˆë¡œ ë°°í¬ëœ ${env.TARGET_ENV} í™˜ê²½ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
                    
                    // íŠ¸ë˜í”½ ì „í™˜ ì „ì— ì‹¤íŒ¨í•œ ê²½ìš°ë§Œ ëŒ€ìƒ í™˜ê²½ ì»¨í…Œì´ë„ˆ ì •ë¦¬
                    sshCommand("cd ${DEPLOY_DIR} && docker compose -p omypic-${env.TARGET_ENV} -f docker-compose-${env.TARGET_ENV}.yml down --remove-orphans || echo 'ì‹¤íŒ¨í•œ ëŒ€ìƒ í™˜ê²½(${env.TARGET_ENV}) ì •ë¦¬ì— ì‹¤íŒ¨í–ˆê±°ë‚˜ ì´ë¯¸ ì¤‘ì§€ë¨'")
                    echo "${env.TARGET_ENV} í™˜ê²½(${env.TARGET_PROJECT})ì„ ì¤‘ì§€/ì •ë¦¬í–ˆìŠµë‹ˆë‹¤." // ë¡œê·¸ ë©”ì‹œì§€ë„ ëª…í™•í•˜ê²Œ
                }
                
                addGitLabMRComment comment: "âŒ ë°°í¬ ì‹¤íŒ¨: ${env.BUILD_URL}\nì›ì¸ì„ í™•ì¸í•˜ì„¸ìš”."
            }
        }
        
        always {
            cleanWs()
        }
    }
}