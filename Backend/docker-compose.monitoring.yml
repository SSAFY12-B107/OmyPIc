version: '3.8'

# OmyPIC 모니터링 스택 - Prometheus, Grafana, Redis Exporter, Flower
# 목적: 프로덕션 환경에서 시스템 성능과 안정성을 실시간 모니터링
# 작성일: 2025-12-18

services:
  # Prometheus - 메트릭 수집 및 저장
  # 역할: FastAPI, Redis, Celery로부터 메트릭을 주기적으로 수집
  # 면접 포인트: Pull 기반 모니터링, 시계열 데이터베이스, PromQL 쿼리 언어
  prometheus:
    image: prom/prometheus:latest
    container_name: omypic_prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"  # Prometheus Web UI
    volumes:
      # 설정 파일 마운트 (스크래핑 타겟, 규칙 정의)
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      # 데이터 영속성 - 컨테이너 재시작 시에도 메트릭 데이터 유지
      - prometheus_data:/prometheus
    command:
      # 설정 파일 위치 지정
      - '--config.file=/etc/prometheus/prometheus.yml'
      # 데이터 저장 경로
      - '--storage.tsdb.path=/prometheus'
      # 데이터 보존 기간 (30일)
      - '--storage.tsdb.retention.time=30d'
      # 웹 콘솔 활성화
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      # 외부 접근 허용
      - '--web.enable-lifecycle'
    networks:
      - omypic_network
    # 헬스체크: Prometheus 정상 동작 확인
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Grafana - 메트릭 시각화 대시보드
  # 역할: Prometheus 데이터를 그래프, 차트로 시각화
  # 면접 포인트: 데이터 소스 연동, 대시보드 프로비저닝, 알림 설정
  grafana:
    image: grafana/grafana:latest
    container_name: omypic_grafana
    restart: unless-stopped
    ports:
      - "3001:3000"  # Grafana Web UI (포트 3000 충돌 방지)
    volumes:
      # Grafana 데이터 영속성 (대시보드, 사용자 설정)
      - grafana_data:/var/lib/grafana
      # 데이터소스 자동 프로비저닝
      - ./monitoring/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      # 대시보드 자동 프로비저닝
      - ./monitoring/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
    environment:
      # 기본 관리자 계정 설정
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=omypic123
      # 익명 접근 비활성화 (보안)
      - GF_AUTH_ANONYMOUS_ENABLED=false
      # 사용자 등록 비활성화
      - GF_USERS_ALLOW_SIGN_UP=false
      # 로깅 레벨
      - GF_LOG_LEVEL=info
    networks:
      - omypic_network
    depends_on:
      - prometheus
    # 헬스체크: Grafana 정상 동작 확인
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis Exporter - Redis 메트릭 수집기
  # 역할: Redis 서버의 상태를 Prometheus 형식으로 변환
  # 면접 포인트: Exporter 패턴, Redis 성능 지표, 메모리 사용량 모니터링
  redis_exporter:
    image: oliver006/redis_exporter:latest
    container_name: omypic_redis_exporter
    restart: unless-stopped
    ports:
      - "9121:9121"  # Redis Exporter 메트릭 엔드포인트
    environment:
      # Redis 연결 정보 (실제 환경에 맞게 수정 필요)
      # 형식: redis://[password@]host:port
      - REDIS_ADDR=redis:6379
      # Redis 비밀번호가 있는 경우 (선택사항)
      # - REDIS_PASSWORD=your_redis_password
    networks:
      - omypic_network
    # 헬스체크: Redis Exporter 정상 동작 확인
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9121/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Celery Flower - Celery 작업 모니터링 대시보드
  # 역할: Celery 워커, 작업 큐, 실행 중인 태스크 실시간 모니터링
  # 면접 포인트: 비동기 작업 가시성, 워커 상태 관리, 재시도 추적
  flower:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: omypic_flower
    restart: unless-stopped
    command: celery -A celery_worker.celery_app flower --port=5555 --broker=${REDIS_URL}
    ports:
      - "5555:5555"  # Flower Web UI
    environment:
      # Redis 브로커 연결 정보 (.env 파일에서 주입)
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      # Flower 기본 인증 (선택사항)
      # - FLOWER_BASIC_AUTH=admin:omypic123
    volumes:
      # 코드 마운트 (개발 환경)
      - .:/app
    networks:
      - omypic_network
    depends_on:
      - redis
    # 헬스체크: Flower 정상 동작 확인
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5555/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3

# 네트워크 설정
# 목적: 모든 모니터링 컨테이너가 동일 네트워크에서 통신
# 면접 포인트: Docker 네트워크 격리, 서비스 디스커버리
networks:
  omypic_network:
    driver: bridge
    # 외부 네트워크 사용 시 주석 해제
    # external: true

# 볼륨 설정
# 목적: 데이터 영속성 보장 - 컨테이너 재시작/삭제 시에도 데이터 유지
# 면접 포인트: 데이터 영속성, 볼륨 백업 전략
volumes:
  # Prometheus 메트릭 데이터 (시계열 데이터)
  prometheus_data:
    driver: local
  # Grafana 설정 및 대시보드 데이터
  grafana_data:
    driver: local

# 사용법:
# 1. 모니터링 스택 실행:
#    docker-compose -f docker-compose.monitoring.yml up -d
#
# 2. 서비스 접근:
#    - Prometheus: http://localhost:9090
#    - Grafana: http://localhost:3001 (admin/omypic123)
#    - Flower: http://localhost:5555
#
# 3. 로그 확인:
#    docker-compose -f docker-compose.monitoring.yml logs -f
#
# 4. 종료:
#    docker-compose -f docker-compose.monitoring.yml down
#
# 5. 데이터 포함 완전 삭제:
#    docker-compose -f docker-compose.monitoring.yml down -v
