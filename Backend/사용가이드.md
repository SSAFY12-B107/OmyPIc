# FastAPI-Users 라이브러리 사용 가이드.

FastAPI-Users는 FastAPI 애플리케이션에서 사용자 관리 및 인증 기능을 쉽게 구현할 수 있게 도와주는 라이브러리입니다. 이 가이드는 프로젝트에서 사용된 주요 기능들을 설명하고 공식 문서의 어떤 부분을 참고해야 하는지 안내합니다.

## 1. 설치

```bash
pip install fastapi-users[sqlalchemy]
```

## 2. 주요 구성 요소 및 공식 문서 참고 섹션

### 2.1 사용자 모델 (User Model)

**공식 문서**: [User Model](https://fastapi-users.github.io/fastapi-users/10.4/configuration/user-model/)

사용자 모델은 `SQLAlchemyBaseUserTableUUID`를 상속받아 구현합니다:

```python
class UserModel(SQLAlchemyBaseUserTableUUID, Base):
    __tablename__ = "users"
    
    name = Column(String(length=100), nullable=False)
    current_opic_score = Column(String(length=10), nullable=True)
    target_opic_score = Column(String(length=10), nullable=False)
    target_exam_date = Column(Date, nullable=True)
    expected_opic_score = Column(String(length=10), nullable=False)
    auth_provider = Column(String(length=20), nullable=False)
```

`SQLAlchemyBaseUserTableUUID`는 이미 다음 필드들을 포함하고 있습니다:
- `id`: UUID 타입의 고유 식별자
- `email`: 사용자 이메일
- `hashed_password`: 해시된 비밀번호
- `is_active`: 활성 상태 여부
- `is_superuser`: 관리자 여부
- `is_verified`: 이메일 인증 여부

### 2.2 사용자 데이터베이스 (User Database)

**공식 문서**: [User Database](https://fastapi-users.github.io/fastapi-users/10.4/configuration/user-db/)

SQLAlchemy를 사용하는 경우 `SQLAlchemyUserDatabase`를 사용합니다:

```python
async def get_async_session() -> AsyncGenerator[AsyncSession, None]:
    async with async_session_maker() as session:
        yield session

async def get_user_db(session: AsyncSession = Depends(get_async_session)):
    yield SQLAlchemyUserDatabase(session, UserModel)
```

### 2.3 사용자 관리자 (User Manager)

**공식 문서**: [User Manager](https://fastapi-users.github.io/fastapi-users/10.4/configuration/user-manager/)

사용자 생성, 인증, 비밀번호 관리 등의 기능을 담당합니다:

```python
class UserManager(UUIDIDMixin, BaseUserManager[UserModel, uuid.UUID]):
    reset_password_token_secret = SECRET_KEY
    verification_token_secret = SECRET_KEY

    async def on_after_register(self, user: UserModel, request: Optional[Request] = None):
        # 사용자 등록 후 실행되는 로직
        print(f"User {user.id} has registered.")

    # 소셜 로그인을 위한 메서드 추가
    async def create_social_user(self, provider: str, social_id: str, social_email: str, name: str):
        # 소셜 로그인 사용자 생성 로직
        # 온보딩을 통해 추가 정보(target_opic_score, expected_opic_score)를 수집하므로 
        # 사용자 생성 시에는 기본 정보만 저장
```

`create_social_user` 메서드는 fastapi-users에서 직접 제공하지 않으므로 직접 구현해야 합니다.

### 2.4 인증 백엔드 (Authentication Backends)

**공식 문서**: [Authentication Backends](https://fastapi-users.github.io/fastapi-users/10.4/configuration/authentication-backends/)

인증 백엔드는 사용자 인증 방식을 정의합니다. 프로젝트에서는 두 가지 백엔드를 사용합니다:

1. **JWT 백엔드 (액세스 토큰용)**:
```python
bearer_transport = BearerTransport(tokenUrl="auth/jwt/login")
auth_backend = AuthenticationBackend(
    name="jwt",
    transport=bearer_transport,
    get_strategy=get_jwt_strategy,
)
```

2. **리프레시 토큰 백엔드 (쿠키 기반)**:
```python
cookie_transport = CustomCookieTransport(...)
refresh_backend = AuthenticationBackend(
    name="refresh",
    transport=cookie_transport,
    get_strategy=get_refresh_strategy,
)
```

### 2.5 인증 전략 (Authentication Strategies)

**공식 문서**: [Authentication Strategies](https://fastapi-users.github.io/fastapi-users/10.4/configuration/authentication-strategies/)

토큰 생성 및 검증 방식을 정의합니다:

1. **JWT 전략**: `JWTStrategy`
```python
def get_jwt_strategy() -> JWTStrategy:
    return JWTStrategy(
        secret=SECRET_KEY, 
        lifetime_seconds=ACCESS_TOKEN_EXPIRE_MINUTES * 60,
        algorithm=JWT_ALGORITHM,
        token_audience=["fastapi-users:auth"]
    )
```

2. **Redis 전략**: `RedisStrategy`
```python
async def get_refresh_strategy(redis_client: redis.Redis) -> RedisStrategy:
    return RedisStrategy(
        redis_client, 
        lifetime_seconds=REFRESH_TOKEN_EXPIRE_DAYS * 24 * 60 * 60,
        token_audience=["fastapi-users:refresh"]
    )
```

### 2.6 FastAPIUsers 인스턴스

**공식 문서**: [FastAPIUsers](https://fastapi-users.github.io/fastapi-users/10.4/configuration/fastapi-users/)

인증 백엔드와 사용자 관리자를 연결하는 핵심 컴포넌트:

```python
fastapi_users = FastAPIUsers[UserModel, uuid.UUID](
    get_user_manager, 
    [auth_backend, refresh_backend]
)
```

### 2.7 의존성 (Dependencies)

**공식 문서**: [Current User](https://fastapi-users.github.io/fastapi-users/10.4/usage/current-user/)

현재 인증된 사용자를 가져오는 의존성:

```python
current_active_user = fastapi_users.current_user(active=True)
```

이 의존성을 엔드포인트에 주입하여 인증된 사용자만 접근할 수 있도록 합니다:

```python
@app.get("/users/me")
def get_user(user: UserModel = Depends(current_active_user)):
    return user
```

### 2.8 라우터 (Routers)

**공식 문서**: [Routers](https://fastapi-users.github.io/fastapi-users/10.4/usage/routers/)

FastAPI-Users는 인증 관련 라우터를 제공합니다:

```python
app.include_router(
    fastapi_users.get_auth_router(auth_backend),
    prefix="/auth/jwt",
    tags=["auth"],
)
```

이 라우터는 다음 엔드포인트를 자동으로 생성합니다:
- `POST /auth/jwt/login`: 로그인
- `POST /auth/jwt/logout`: 로그아웃

## 3. 소셜 로그인 및 온보딩 구현

FastAPI-Users는 소셜 로그인을 직접 지원하지 않으므로, 소셜 로그인 로직은 별도로 구현해야 합니다:

1. **소셜 로그인 시작 엔드포인트**:
```python
@app.get("/auth/kakao/login")
async def kakao_login():
    """카카오 로그인 페이지로 리다이렉션"""
    kakao_auth_url = (
        f"https://kauth.kakao.com/oauth/authorize"
        f"?client_id={KAKAO_CLIENT_ID}"
        f"&redirect_uri={KAKAO_REDIRECT_URI}"
        f"&response_type=code"
    )
    return RedirectResponse(url=kakao_auth_url)
```

2. **콜백 처리 엔드포인트**:
```python
@app.get("/auth/kakao/callback")
async def kakao_callback(
    response: Response,
    code: str, 
    user_manager: UserManager = Depends(get_user_manager),
    refresh_strategy: Strategy = Depends(get_refresh_strategy)
):
    # 카카오 인증 코드를 사용하여 액세스 토큰 요청
    # 사용자 정보 가져오기
    # 사용자 생성 또는 로그인 처리
    # JWT 토큰 발급
    
    # 온보딩 상태에 따라 리다이렉트 경로 결정
    redirect_path = "/onboarding" if not user.is_onboarded else "/login/success"
```

3. **UserManager 확장**:
```python
async def create_social_user(
    self,
    provider: str,
    social_id: str,
    social_email: str,
    name: str,
) -> UserModel:
    # 기존 사용자 확인 또는 새 사용자 생성
    # is_onboarded를 False로 설정하여 온보딩 필요함을 표시
```

4. **온보딩 엔드포인트**:
```python
@app.post("/users/onboarding")
async def complete_onboarding(
    onboarding_data: Dict,
    user: UserModel = Depends(current_active_user),
    session: AsyncSession = Depends(get_async_session),
):
    # 필수 필드 검증 (target_opic_score, expected_opic_score)
    # 사용자 정보 업데이트
    # is_onboarded를 True로 설정
```

## 4. 토큰 갱신 구현

FastAPI-Users는 액세스 토큰과 리프레시 토큰의 분리를 직접 지원하지 않으므로, 토큰 갱신 로직은 별도로 구현해야 합니다:

1. **커스텀 쿠키 트랜스포트 구현**:
```python
class CustomCookieTransport(CookieTransport):
    """
    기본 CookieTransport를 확장하여 쿠키를 직접 설정할 수 있는 메서드 추가
    """
    def set_refresh_token_cookie(self, response: Response, token: str):
        # 쿠키 설정 로직
```

2. **토큰 갱신 엔드포인트 구현**:
```python
@app.post("/auth/refresh")
async def refresh_tokens(
    response: Response,
    refresh_token: str = Cookie(None, alias="refresh_token"),
    refresh_strategy: Strategy = Depends(get_refresh_strategy),
    jwt_strategy: JWTStrategy = Depends(get_jwt_strategy),
    user_manager: UserManager = Depends(get_user_manager),
):
    # 리프레시 토큰 검증
    # 새 액세스 토큰과 리프레시 토큰 발급
```

## 5. 주요 커스터마이징 포인트

FastAPI-Users를 사용할 때 주로 커스터마이징이 필요한 부분:

1. **사용자 모델**: 필요한 필드 추가 (프로필 정보 등)
2. **사용자 관리자**: 사용자 생성/인증 로직 커스터마이징
3. **인증 전략**: 토큰 수명, 알고리즘 등 설정
4. **소셜 로그인**: 전체 흐름 직접 구현
5. **토큰 갱신**: 액세스/리프레시 토큰 관리 로직 구현

## 6. 주의사항

1. **버전 의존성**: FastAPI-Users 버전에 따라 API가 다를 수 있으므로, 항상 현재 사용 중인 버전의 문서를 참고하세요.
2. **소셜 로그인**: FastAPI-Users는 소셜 로그인을 직접 지원하지 않으므로 별도로 구현해야 합니다.
3. **토큰 관리**: 액세스 토큰과 리프레시 토큰을 분리하여 관리하려면 커스텀 로직이 필요합니다.
4. **보안**: 프로덕션 환경에서는 적절한 보안 설정(HTTPS, 쿠키 보안 등)을 적용해야 합니다.
5. **Redis 의존성**: 리프레시 토큰 관리를 위해 Redis를 사용하므로, Redis 서버 설정이 필요합니다.

## 7. 확장 및 고급 사용 사례

### 7.1 다중 인증 백엔드 사용

여러 인증 방식을 동시에 지원하려면 여러 인증 백엔드를 등록할 수 있습니다:

```python
fastapi_users = FastAPIUsers(
    get_user_manager, 
    [jwt_backend, cookie_backend]
)
```

### 7.2 인증 요구사항 커스터마이징

특정 엔드포인트에 대한 인증 요구사항을 커스터마이징할 수 있습니다:

```python
# 활성 사용자만 접근 가능
current_active_user = fastapi_users.current_user(active=True)

# 관리자만 접근 가능
current_superuser = fastapi_users.current_user(active=True, superuser=True)

# 이메일 인증된 사용자만 접근 가능
current_verified_user = fastapi_users.current_user(active=True, verified=True)
```

### 7.3 사용자 정의 OAuth 제공자 추가

FastAPI-Users는 기본적인 OAuth 지원을 제공하지만, 프로젝트에서는 소셜 로그인 흐름을 더 세밀하게 제어하기 위해 직접 구현했습니다.

### 7.4 사용자 데이터 CRUD 작업

FastAPI-Users는 기본적인 사용자 CRUD 엔드포인트를 제공합니다:

```python
app.include_router(
    fastapi_users.get_users_router(),
    prefix="/users",
    tags=["users"],
)
```

이는 다음 엔드포인트를 생성합니다:
- `GET /users/me`: 현재 사용자 정보 조회
- `PATCH /users/me`: 현재 사용자 정보 업데이트
- `GET /users/{id}`: 특정 사용자 정보 조회 (관리자만)
- `PATCH /users/{id}`: 특정 사용자 정보 업데이트 (관리자만)
- `DELETE /users/{id}`: 특정 사용자 삭제 (관리자만)

## 8. 문제 해결 및 디버깅 팁

### 8.1 인증 관련 문제

- **401 Unauthorized 오류**: 
  - 토큰이 만료되었거나 잘못된 형식일 수 있습니다.
  - Authorization 헤더 형식이 올바른지 확인하세요 (`Bearer {token}`).

- **리프레시 토큰 오류**: 
  - 쿠키 설정(보안, 도메인, SameSite 등)을 확인하세요.
  - HTTPS 사용 시 `cookie_secure=True`로 설정해야 합니다.

- **토큰 변조 오류**: 
  - `SECRET_KEY`가 변경되었는지 확인하세요.
  - 다른 환경(개발, 운영)에서 동일한 `SECRET_KEY`를 사용하고 있는지 확인하세요.

### 8.2 Redis 문제

- **Redis 연결 오류**: 
  - Redis 서버가 실행 중인지 확인하세요.
  - `REDIS_URL` 설정이 올바른지 확인하세요.

- **토큰이 저장되지 않는 문제**: 
  - Redis 클라이언트 설정을 확인하세요.
  - `encoding="utf-8", decode_responses=True` 옵션이 설정되었는지 확인하세요.

### 8.3 소셜 로그인 문제

- **리다이렉트 오류**: 
  - 소셜 서비스 개발자 콘솔에서 리다이렉트 URI 설정을 확인하세요.
  - URI가 정확히 일치해야 합니다 (trailing slash 포함).

- **권한 오류**: 
  - 필요한 권한(이메일, 프로필 등)을 요청했는지 확인하세요.
  - 사용자가 권한을 거부했는지 확인하세요.

## 9. 추가 참고 자료

- [FastAPI-Users GitHub Repository](https://github.com/fastapi-users/fastapi-users)
- [FastAPI 공식 문서](https://fastapi.tiangolo.com/)
- [JWT 인증 가이드](https://fastapi.tiangolo.com/tutorial/security/oauth2-jwt/)
- [Redis 공식 문서](https://redis.io/documentation)

## 10. 요약

FastAPI-Users는 사용자 관리 및 인증의 기본 프레임워크를 제공하지만, 소셜 로그인 및 토큰 갱신과 같은 고급 기능은 직접 구현해야 합니다. 이 가이드가 FastAPI-Users를 효과적으로 사용하는 데 도움이 되길 바랍니다.